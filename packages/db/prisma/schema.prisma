generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Event {
  id                    String   @id @default(uuid()) @db.Uuid
  crypto                String   @db.VarChar(10)
  name                  String   @db.VarChar(100)
  slugPattern           String   @default("{crypto}-updown-15m-{timestamp}") @map("slug_pattern") @db.VarChar(100)
  tradingWindowSeconds  Int      @default(10) @map("trading_window_seconds")
  threshold             Decimal  @default(0.99) @db.Decimal(4, 3)
  betAmountUsdc         Decimal  @default(10.00) @map("bet_amount_usdc") @db.Decimal(10, 2)
  enabled               Boolean  @default(true)
  createdAt             DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt             DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  trades     Trade[]
  workerLogs WorkerLog[]
  priceSnapshots PriceSnapshot[]

  @@unique([crypto])
  @@map("events")
}

model Trade {
  id              String    @id @default(uuid()) @db.Uuid
  eventId         String    @map("event_id") @db.Uuid
  marketSlug      String    @unique @map("market_slug") @db.VarChar(100)
  windowStart     DateTime  @map("window_start") @db.Timestamptz
  windowEnd       DateTime  @map("window_end") @db.Timestamptz
  side            String    @db.VarChar(4)
  tokenId         String    @map("token_id") @db.VarChar(100)
  betAmount       Decimal   @map("bet_amount") @db.Decimal(10, 2)
  entryPrice      Decimal   @map("entry_price") @db.Decimal(5, 4)
  status          String    @default("pending") @db.VarChar(20)
  orderId         String?   @map("order_id") @db.VarChar(100)
  transactionHash String?   @map("transaction_hash") @db.VarChar(100)
  outcome         String?   @db.VarChar(10)
  payout          Decimal?  @db.Decimal(10, 2)
  errorMessage    String?   @map("error_message")
  retryCount      Int       @default(0) @map("retry_count")
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  executedAt      DateTime? @map("executed_at") @db.Timestamptz
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([eventId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([outcome])
  @@map("trades")
}

model WorkerLog {
  id         BigInt   @id @default(autoincrement())
  eventId    String?  @map("event_id") @db.Uuid
  workerId   String   @map("worker_id") @db.VarChar(50)
  jobId      String?  @map("job_id") @db.VarChar(100)
  marketSlug String?  @map("market_slug") @db.VarChar(100)
  level      String   @default("info") @db.VarChar(10)
  message    String
  metadata   Json?
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  event Event? @relation(fields: [eventId], references: [id], onDelete: SetNull)

  @@index([eventId])
  @@index([createdAt(sort: Desc)])
  @@index([level])
  @@map("worker_logs")
}

model PriceSnapshot {
  id         BigInt   @id @default(autoincrement())
  eventId    String   @map("event_id") @db.Uuid
  marketSlug String   @map("market_slug") @db.VarChar(100)
  upPrice    Decimal  @map("up_price") @db.Decimal(5, 4)
  downPrice  Decimal  @map("down_price") @db.Decimal(5, 4)
  capturedAt DateTime @default(now()) @map("captured_at") @db.Timestamptz

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)

  @@index([marketSlug])
  @@index([capturedAt(sort: Desc)])
  @@map("price_snapshots")
}

model Setting {
  key       String   @id @db.VarChar(50)
  value     Json
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz

  @@map("settings")
}
